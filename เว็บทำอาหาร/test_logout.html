<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Logout</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="auth.js"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Login/Logout</h1>
    
    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <!-- Login Panel -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">1. Login</h2>
        <div class="space-y-4">
          <select id="userSelect" class="w-full p-2 border rounded">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ --</option>
            <option value="admin">admin</option>
            <option value="staff1">staff1</option>
            <option value="staff2">staff2</option>
          </select>
          <button onclick="testLogin()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
            ‚úÖ Login
          </button>
        </div>
      </div>

      <!-- Logout Panel -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">2. Logout</h2>
        <div class="space-y-4">
          <div id="currentUserDisplay" class="p-3 bg-gray-100 rounded mb-4"></div>
          <button onclick="testLogout()" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600">
            ‚ùå Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Status Display -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">3. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
      <button onclick="checkStatus()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-4">
        üîÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
      </button>
      <div id="statusDisplay"></div>
    </div>

    <!-- Log Panel -->
    <div class="bg-gray-800 text-white p-6 rounded-lg">
      <h2 class="text-xl font-bold mb-4">üìã Log</h2>
      <div id="logPanel" class="space-y-1 text-sm font-mono max-h-64 overflow-y-auto"></div>
    </div>
  </div>

  <script>
    function log(message, type = 'info') {
      const logPanel = document.getElementById('logPanel');
      const time = new Date().toLocaleTimeString();
      const colors = {
        info: 'text-blue-400',
        success: 'text-green-400',
        warning: 'text-yellow-400',
        error: 'text-red-400'
      };
      const entry = document.createElement('div');
      entry.className = colors[type] || colors.info;
      entry.textContent = `[${time}] ${message}`;
      logPanel.appendChild(entry);
      logPanel.scrollTop = logPanel.scrollHeight;
    }

    function testLogin() {
      const username = document.getElementById('userSelect').value;
      if (!username) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
        return;
      }

      const users = {
        'admin': { username: 'admin', password: 'admin', role: 'admin' },
        'staff1': { username: 'staff1', password: 'staff1', role: 'staff' },
        'staff2': { username: 'staff2', password: 'staff2', role: 'staff' }
      };

      const user = users[username];
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô login ‡∏à‡∏≤‡∏Å auth.js
      const result = login(user.username, user.password, user.role);
      
      if (result) {
        log(`‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${username}`, 'success');
        updateCurrentUserDisplay();
        checkStatus();
      } else {
        log(`‚ùå Login ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${username}`, 'error');
      }
    }

    function testLogout() {
      const currentUser = getCurrentUser();
      if (!currentUser) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login');
        return;
      }

      const username = currentUser.username;
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô logout
      log(`üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Logout: ${username}`, 'warning');
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô logout ‡∏à‡∏≤‡∏Å auth.js
      // ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà redirect (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ)
      const currentUserJson = sessionStorage.getItem('restaurant_current_user');
      
      if (currentUserJson) {
        try {
          const user = JSON.parse(currentUserJson);
          
          // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å online_users list
          const onlineUsers = JSON.parse(localStorage.getItem('online_users') || '[]');
          const filteredUsers = onlineUsers.filter(u => u.username !== user.username);
          localStorage.setItem('online_users', JSON.stringify(filteredUsers));
          
          log(`‚úÖ ‡∏•‡∏ö ${user.username} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å online_users ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        } catch (e) {
          log(`‚ùå Error: ${e.message}`, 'error');
        }
      }
      
      // ‡∏•‡∏ö sessionStorage
      sessionStorage.removeItem('restaurant_current_user');
      
      log(`‚úÖ Logout ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${username}`, 'success');
      updateCurrentUserDisplay();
      checkStatus();
    }

    function updateCurrentUserDisplay() {
      const display = document.getElementById('currentUserDisplay');
      const currentUser = getCurrentUser();
      
      if (currentUser) {
        display.innerHTML = `
          <p class="font-semibold text-green-600">‚úÖ Login ‡∏≠‡∏¢‡∏π‡πà</p>
          <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${currentUser.username}</p>
          <p>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${currentUser.role}</p>
        `;
      } else {
        display.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login</p>';
      }
    }

    function checkStatus() {
      const display = document.getElementById('statusDisplay');
      const users = ['admin', 'staff1', 'staff2'];
      
      let html = '<div class="space-y-4">';
      
      // 1. Current User
      const currentUser = getCurrentUser();
      html += `
        <div class="p-4 ${currentUser ? 'bg-green-50' : 'bg-gray-50'} rounded">
          <h3 class="font-bold mb-2">Current User:</h3>
          <p class="text-sm">${currentUser ? `${currentUser.username} (${currentUser.role})` : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</p>
        </div>
      `;
      
      // 2. Online Users
      const onlineUsers = JSON.parse(localStorage.getItem('online_users') || '[]');
      html += `
        <div class="p-4 bg-blue-50 rounded">
          <h3 class="font-bold mb-2">Online Users (${onlineUsers.length}):</h3>
          ${onlineUsers.length > 0 ? `
            <ul class="text-sm space-y-1">
              ${onlineUsers.map(u => `<li>‚Ä¢ ${u.username} (${u.role})</li>`).join('')}
            </ul>
          ` : '<p class="text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ</p>'}
        </div>
      `;
      
      // 3. Last Login Times
      html += `
        <div class="p-4 bg-yellow-50 rounded">
          <h3 class="font-bold mb-2">Last Login Times:</h3>
          <ul class="text-sm space-y-1">
      `;
      
      users.forEach(username => {
        const lastLogin = localStorage.getItem(`last_login_${username}`);
        if (lastLogin) {
          const date = new Date(parseInt(lastLogin));
          const timeDiff = Date.now() - parseInt(lastLogin);
          const minutes = Math.floor(timeDiff / 60000);
          html += `<li>‚Ä¢ ${username}: ${date.toLocaleTimeString()} (${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß)</li>`;
        } else {
          html += `<li>‚Ä¢ ${username}: ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢ login</li>`;
        }
      });
      
      html += `
          </ul>
        </div>
      `;
      
      html += '</div>';
      display.innerHTML = html;
    }

    // Initialize
    log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
    updateCurrentUserDisplay();
    checkStatus();
  </script>
</body>
</html>
